// === CONFIGURACIÃ“N EMAILJS ===
const EJS = {
    PK: 'O2kllI3D7gSLogv-y', // AsegÃºrate de que esta clave sea correcta
    SID: 'service_asirte',
    TPL_CLI: 'template_cliente_asirte',
    TPL_EQ: 'template_equipo_asirte'
};

// === PRECIOS BASE (CUP) ===
const costosBase = {
    "ACM": {"4": 1500, "6": 1950, "8": 2400, "12": 2850, "nocturno": 3000, "24h": 3200},
    "AC": {"4": 1750, "6": 2275, "8": 2800, "12": 3325, "nocturno": 3590, "24h": 3850},
    "AH": {"4": 1950, "6": 2535, "8": 3120, "12": 3705, "nocturno": 3998, "24h": 4290},
    "CC": {"4": 2150, "6": 2795, "8": 3440, "12": 4085, "nocturno": 4410, "24h": 4730},
    "CH": {"4": 2350, "6": 3055, "8": 3760, "12": 4465, "nocturno": 4820, "24h": 5170},
    "CIC": {"4": 2550, "6": 3315, "8": 4080, "12": 4845, "nocturno": 5230, "24h": 5610},
    "CEI": {"4": 2750, "6": 3575, "8": 4400, "12": 5225, "nocturno": 5640, "24h": 6050}
};

// === COSTOS ADICIONALES (CUP) ===
const costosAdicionales = {
    "acompanamiento-consultas": 0,
    "supervision-tratamiento": 0,
    "estimulacion-sensorial": 0,
    "paseos-movilidad": 0,
    "ducha": 150,
    "signos": 50,
    "adiestramiento-autonomia": 0,
    "asesoria": 50,
    "seguimiento-heridas": 0,
    "cuidados-piel": 0,
    "movilizacion-hogar": 0,
    "movilizacion": 100,
    "alimentacion": 50,
    "camas": 200,
    "masajes": 50,
    "curas": 150,
    "reeducacion-vesical": 0,
    "supervision-psicoticos": 0,
    "cuidados-criticos": 0,
    "rehabilitacion-postoperatoria": 0,
    "tareas": 200,
    "compras": 400
};

// === NIVELES DE CADA SERVICIO ===
const niveles = {
    "ACM": 1,
    "AC": 2,
    "AH": 3,
    "CC": 4,
    "CH": 5,
    "CIC": 6,
    "CEI": 7
};

// === SERVICIOS POR NIVEL ===
const serviciosPorNivel = {
    1: ["acompanamiento-consultas"],
    2: ["supervision-tratamiento", "estimulacion-sensorial", "paseos-movilidad"],
    3: ["ducha", "signos"],
    4: ["adiestramiento-autonomia", "asesoria", "seguimiento-heridas", "cuidados-piel", "movilizacion-hogar"],
    5: ["movilizacion", "alimentacion", "camas", "masajes"],
    6: ["curas", "reeducacion-vesical"],
    7: ["supervision-psicoticos", "cuidados-criticos", "rehabilitacion-postoperatoria", "tareas"]
};

// === VARIABLES GLOBALES ===
let temp;
let tRestante = 60;
let datosSolicitud = null;
let procesamientoEnCurso = false;

// === NÃšMERO WHATSAPP ===
const NUMERO_WHATSAPP_AGENCIA = '5350633453';

// ðŸ”¥ URL APPS SCRIPT (REEMPLAZA ESTO POR TU DEPLOYMENT ID REAL)
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzPDcdOfue0JeKUmZufImzP-AzE-A-MGuNvsECpdcq7fHEPXhH6NTWhXMbbv5BBB0r2/exec";

// === CALCULAR COSTO (IGUAL QUE ANTES) ===
function calcularCosto() {
    const serv = document.getElementById('servicio').value;
    const hora = document.getElementById('horario').value;
    const dur = document.getElementById('duracion').value;
    if (!serv || !hora || !dur) {
        document.getElementById('costo-hora-container').style.display = 'none';
        document.getElementById('costo-turno-container').style.display = 'none';
        document.getElementById('resultado-container').style.display = 'none';
        document.getElementById('mensaje-ocultado').style.display = 'block';
        return;
    }
    let costoBase;
    if (hora === '24h') {
        costoBase = costosBase[serv]['24h'];
    } else {
        costoBase = costosBase[serv][hora === 'nocturno' ? 'nocturno' : dur];
    }
    const nivelServ = niveles[serv];
    let incl = [];
    let adic = [];
    for (const nivel in serviciosPorNivel) {
        if (parseInt(nivel) <= nivelServ) {
            incl = incl.concat(serviciosPorNivel[nivel]);
        } else {
            adic = adic.concat(serviciosPorNivel[nivel]);
        }
    }
    Object.keys(costosAdicionales).forEach(k => {
        const cb = document.getElementById(k);
        const item = document.getElementById(`item-${k}`);
        if (cb && item) {
            const estaIncluido = incl.includes(k);
            if (estaIncluido) {
                cb.disabled = true;
                cb.checked = false;
                item.classList.add('incluido');
            } else {
                cb.disabled = false;
                item.classList.remove('incluido');
            }
        }
    });
    let adicionales = 0;
    adic.forEach(k => {
        if (document.getElementById(k)?.checked) {
            adicionales += costosAdicionales[k];
        }
    });
    const total = costoBase + adicionales;
    const horas = hora === '24h' ? 24 : parseInt(dur);
    const costoHora = Math.round(total / horas);
    document.getElementById('costo-hora').textContent = costoHora.toLocaleString();
    document.getElementById('costo-turno').textContent = total.toLocaleString();
    if (formCompleto()) {
        document.getElementById('costo-hora-container').style.display = 'block';
        document.getElementById('costo-turno-container').style.display = 'block';
        document.getElementById('mensaje-ocultado').style.display = 'none';
        document.getElementById('resultado-container').style.display = 'block';
    } else {
        document.getElementById('costo-hora-container').style.display = 'none';
        document.getElementById('costo-turno-container').style.display = 'none';
        document.getElementById('resultado-container').style.display = 'none';
        document.getElementById('mensaje-ocultado').style.display = 'block';
    }
    validarForm();
}

// === LIMPIAR, VALIDAR, etc. (IGUALES) ===
function limpiarForm() {
    ['nombre-cliente','email','telefono','nombre-paciente','relacion','direccion','edad-paciente','padecimientos','otros-apuntes'].forEach(id => {
        document.getElementById(id).value = '';
    });
    ['servicio','horario','duracion'].forEach(id => {
        document.getElementById(id).value = '';
    });
    Object.keys(costosAdicionales).forEach(k => {
        const cb = document.getElementById(k);
        const item = document.getElementById(`item-${k}`);
        if (cb && item) {
            cb.checked = false;
            cb.disabled = false;
            item.classList.remove('incluido');
        }
    });
    document.getElementById('costo-hora-container').style.display = 'none';
    document.getElementById('costo-turno-container').style.display = 'none';
    document.getElementById('resultado-container').style.display = 'none';
    document.getElementById('timer-display').style.display = 'none';
    document.getElementById('btn-borrar').style.display = 'none';
    document.getElementById('btn-nueva-cotizacion').style.display = 'none';
    document.getElementById('btn-cancelar').style.display = 'none';
    document.getElementById('mensaje-ocultado').style.display = 'block';
    document.querySelectorAll('.error-message').forEach(e => e.style.display = 'none');
    document.getElementById('terminos').checked = false;
    document.getElementById('terms-container').style.display = 'block';
    clearTimeout(temp);
    tRestante = 60;
    document.getElementById('mensaje-confirmacion').style.display = 'none';
    document.getElementById('mensaje-error-general').style.display = 'none';
    document.getElementById('btn-confirmar-whatsapp').style.display = 'none';
    document.getElementById('btn-cotizar').style.display = 'block';
    document.getElementById('btn-cotizar').classList.add('btn-disabled');
    document.getElementById('btn-cotizar').disabled = true;
    validarForm();
}

function reiniciarTemp() {
    clearTimeout(temp);
    if (formCompleto()) {
        document.getElementById('timer-countdown').textContent = tRestante;
        temp = setInterval(() => {
            tRestante--;
            if (tRestante <= 0) {
                limpiarForm();
                clearInterval(temp);
            } else {
                document.getElementById('timer-countdown').textContent = tRestante;
            }
        }, 1000);
    }
}

function formCompleto() {
    const req = ['nombre-cliente', 'email', 'telefono', 'nombre-paciente', 'relacion', 'direccion', 'edad-paciente'];
    let todos = req.every(id => document.getElementById(id).value.trim() !== '');
    const email = document.getElementById('email').value;
    const emailValido = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    const tel = document.getElementById('telefono').value;
    const telValido = tel.replace(/\D/g, '').length >= 8;
    const serv = document.getElementById('servicio').value;
    const hora = document.getElementById('horario').value;
    const dur = document.getElementById('duracion').value;
    const term = document.getElementById('terminos').checked;
    return todos && emailValido && telValido && serv && hora && dur && term;
}

function validarForm() {
    let valido = true;
    const validarCampo = (id, validador, msg) => {
        const valor = document.getElementById(id).value.trim();
        const error = document.getElementById(`error-${id}`);
        if (!valor || !validador(valor)) {
            error.style.display = 'block';
            valido = false;
        } else {
            error.style.display = 'none';
        }
    };
    validarCampo('nombre-cliente', v => v.length >= 3, 'nombre');
    validarCampo('nombre-paciente', v => v.length >= 3, 'nombre');
    validarCampo('relacion', v => v.length > 0, 'relacion');
    validarCampo('direccion', v => /\d/.test(v), 'direccion');
    validarCampo('email', v => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v), 'email');
    validarCampo('telefono', v => v.replace(/\D/g, '').length >= 8, 'telefono');
    validarCampo('edad-paciente', v => v >= 0 && v <= 120, 'edad');
    ['servicio','horario','duracion'].forEach(id => {
        const campo = document.getElementById(id);
        const error = document.getElementById(`error-${id}`);
        error.style.display = campo.value ? 'none' : 'block';
        if (!campo.value) valido = false;
    });
    document.getElementById('error-terminos').style.display = document.getElementById('terminos').checked ? 'none' : 'block';
    if (!document.getElementById('terminos').checked) valido = false;
    const btn = document.getElementById('btn-cotizar');
    btn.disabled = !valido;
    btn.classList.toggle('btn-disabled', !valido);
    if (valido && document.getElementById('servicio').value && document.getElementById('horario').value && document.getElementById('duracion').value) {
        document.getElementById('costo-hora-container').style.display = 'block';
        document.getElementById('costo-turno-container').style.display = 'block';
        document.getElementById('mensaje-ocultado').style.display = 'none';
        document.getElementById('resultado-container').style.display = 'block';
    } else {
        document.getElementById('costo-hora-container').style.display = 'none';
        document.getElementById('costo-turno-container').style.display = 'none';
        document.getElementById('resultado-container').style.display = 'none';
        document.getElementById('mensaje-ocultado').style.display = 'block';
    }
    return valido;
}

// ðŸ”¥ NUEVO: ENVIAR A APPS SCRIPT (CORREGIDO)
async function enviarConAppsScript(datos) {
    const formData = new FormData();
    // Mapeo EXACTO a 17 columnas de tu Sheet (Aâ€“Q) - AsegÃºrate que coincidan
    formData.append("timestamp", datos.timestamp);
    formData.append("nombreCliente", datos.nombreCliente);
    formData.append("email", datos.email);
    formData.append("telefono", datos.telefono);
    formData.append("nombrePaciente", datos.nombrePaciente);
    formData.append("edadPaciente", datos.edadPaciente);
    formData.append("relacion", datos.relacion);
    formData.append("direccion", datos.direccion);
    formData.append("padecimientos", datos.padecimientos || "Ninguno");
    formData.append("otrosApuntes", datos.otrosApuntes || "Ninguno");
    formData.append("servicio", datos.servicio); // Columna K
    formData.append("duracionHoras", datos.duracion + " horas"); // Columna L
    formData.append("horario", datos.horario); // Columna M
    formData.append("serviciosAdicionales", datos.serviciosAdicionales.join(", ") || "Ninguno"); // Columna N
    formData.append("incompatibilidad", datos.incompatibilidad || "No hay incompatibilidades"); // Columna O
    formData.append("costoBase", datos.costoBase);
    formData.append("total", datos.total); // Columna Q

    try {
        const response = await fetch(APPS_SCRIPT_URL, {
            method: "POST",
            body: formData,
            // No es necesario incluir headers para FormData
        });

        if (!response.ok) {
            // Si la respuesta no es OK, intenta leer el cuerpo de error
            let errorMessage = `HTTP error! status: ${response.status}`;
            try {
                const errorBody = await response.text();
                errorMessage += ` - Body: ${errorBody}`;
            } catch (e) {
                console.error("Could not read error response body:", e);
            }
            throw new Error(errorMessage);
        }

        const result = await response.json();
        if (result.result !== "success") {
            throw new Error(result.message || "Error desconocido del servidor");
        }

        console.log("âœ… Datos enviados a Apps Script con Ã©xito:", result);
        return result; // Devolvemos el resultado para manejarlo arriba

    } catch (error) {
        console.error("âŒ Error al enviar a Apps Script:", error);
        throw error; // Re-lanzamos el error para que lo maneje la funciÃ³n que lo llamÃ³
    }
}

// === RECOPILAR DATOS (CORREGIDO) ===
function recopilarDatos() {
    const nomCli = document.getElementById('nombre-cliente').value;
    const email = document.getElementById('email').value;
    const tel = document.getElementById('telefono').value;
    const nomPac = document.getElementById('nombre-paciente').value;
    const edadPac = document.getElementById('edad-paciente').value;
    const rel = document.getElementById('relacion').value;
    const dir = document.getElementById('direccion').value;
    const padecimientos = document.getElementById('padecimientos').value;
    const otrosApuntes = document.getElementById('otros-apuntes').value;
    const serv = document.getElementById('servicio').value;
    const hora = document.getElementById('horario').value;
    const dur = document.getElementById('duracion').value;

    // Recopilar servicios adicionales
    let servAdic = [];
    Object.keys(costosAdicionales).forEach(k => {
        if (document.getElementById(k)?.checked) {
            servAdic.push(k); // Guardamos el ID del checkbox
        }
    });

    // Calcular costos
    let costoBase = 0;
    if (hora === '24h') {
        costoBase = costosBase[serv]['24h'];
    } else {
        costoBase = costosBase[serv][hora === 'nocturno' ? 'nocturno' : dur];
    }

    let adicionales = 0;
    servAdic.forEach(k => {
        adicionales += costosAdicionales[k];
    });
    const total = costoBase + adicionales;

    // Determinar incompatibilidad
    const nivelServ = niveles[serv];
    let adicDisponibles = [];
    for (const nivel in serviciosPorNivel) {
        if (parseInt(nivel) > nivelServ) {
            adicDisponibles = adicDisponibles.concat(serviciosPorNivel[nivel]);
        }
    }
    const tieneIncompatibilidad = servAdic.some(serv => adicDisponibles.includes(serv));
    const incompatibilidad = tieneIncompatibilidad ? "Algunas necesidades seleccionadas no estÃ¡n incluidas en el tipo de servicio seleccionado, por lo que el costo del servicio puede sufrir alteraciones despuÃ©s de una evaluaciÃ³n presencial." : "No hay incompatibilidades";

    return {
        timestamp: new Date().toISOString(), // Usamos ISOString para una marca de tiempo mÃ¡s estÃ¡ndar
        nombreCliente: nomCli,
        email: email,
        telefono: tel,
        nombrePaciente: nomPac,
        edadPaciente: edadPac,
        relacion: rel,
        direccion: dir,
        padecimientos: padecimientos,
        otrosApuntes: otrosApuntes,
        servicio: serv,
        horario: hora,
        duracion: dur,
        serviciosAdicionales: servAdic,
        costoBase: costoBase,
        total: total,
        incompatibilidad: incompatibilidad
    };
}


// === CORREOS Y WHATSAPP (IGNORADOS POR AHORA) ===
// (Dejamos las funciones de correo y WhatsApp vacÃ­as o comentadas por ahora)
/*
function enviarCorreoCli(datos) {
    // ... cÃ³digo de emailjs ...
}
function enviarCorreoEq(datos) {
    // ... cÃ³digo de emailjs ...
}
*/

function generarMensajeWhatsApp(datos) {
    const costoPorHora = Math.round(datos.total / (datos.horario === '24h' ? 24 : parseInt(datos.duracion)));
    return `*CONFIRMACIÃ“N DE COTIZACIÃ“N ASIRTE*
*Cliente:* ${datos.nombreCliente}
*TelÃ©fono:* ${datos.telefono}
*Servicio:* ${datos.servicio}
*Horario:* ${datos.horario}
*DuraciÃ³n:* ${datos.duracion} horas
*Costo por hora:* ${costoPorHora} CUP
*Costo por turno laboral:* ${datos.total} CUP
*Persona a cuidar:* ${datos.nombrePaciente}
*Edad:* ${datos.edadPaciente}
*RelaciÃ³n:* ${datos.relacion}
*DirecciÃ³n:* ${datos.direccion}
*Padecimientos:* ${datos.padecimientos|| 'Ninguno especificado'}
*Otros apuntes:* ${datos.otrosApuntes|| 'Ninguno especificado'}
*Servicios adicionales:* ${datos.serviciosAdicionales.join(', ')|| 'Ninguno'}`;
}

function enviarWhatsAppAgencia() {
    if (!datosSolicitud) {
        alert('Primero envÃ­e su solicitud.');
        return;
    }
    const url = `https://wa.me/${NUMERO_WHATSAPP_AGENCIA}?text=${encodeURIComponent(generarMensajeWhatsApp(datosSolicitud))}`;
    window.open(url, '_blank');
}

// ðŸ”¥ MODIFICADO: PROCESAR SOLICITUD (SOLO Apps Script)
async function procesarSolicitud() {
    if (procesamientoEnCurso) return;
    if (!formCompleto()) {
        document.getElementById('mensaje-error-general').style.display = 'block';
        document.getElementById('mensaje-error-general').textContent = 'Revise sus datos y rectifique su informaciÃ³n.';
        return;
    }

    procesamientoEnCurso = true;
    const datos = recopilarDatos();
    datosSolicitud = datos;

    document.getElementById('loading-state').style.display = 'block';
    document.getElementById('btn-cotizar').disabled = true;

    try {
        // â˜‘ï¸ SOLO ENVÃO CON APPS SCRIPT
        await enviarConAppsScript(datos);
        console.log("âœ… Solicitud guardada en Google Sheets.");

        // Manejar Ã©xito (sin correo por ahora)
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('mensaje-confirmacion').textContent = 'âœ… Â¡Solicitud enviada correctamente!';
        document.getElementById('mensaje-confirmacion').style.display = 'block';
        limpiarForm();
        document.getElementById('btn-cotizar').style.display = 'none';
        document.getElementById('btn-confirmar-whatsapp').style.display = 'block';

        // Ocultar mensaje de Ã©xito despuÃ©s de 5 segundos
        setTimeout(() => {
            document.getElementById('mensaje-confirmacion').style.display = 'none';
        }, 5000);

    } catch (error) {
        console.error("âŒ Error al procesar la solicitud:", error);
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('mensaje-confirmacion').textContent = `âŒ Error al enviar. Intente de nuevo. (${error.message})`;
        document.getElementById('mensaje-confirmacion').style.display = 'block';
        document.getElementById('btn-cotizar').disabled = false;
        document.getElementById('btn-cotizar').classList.remove('btn-disabled');

        // Ocultar mensaje de error despuÃ©s de 5 segundos
        setTimeout(() => {
            document.getElementById('mensaje-confirmacion').style.display = 'none';
        }, 5000);
    } finally {
        procesamientoEnCurso = false;
    }
}

// === INICIALIZACIÃ“N ===
document.addEventListener('DOMContentLoaded', () => {
    // Inicializar EmailJS si se va a usar (opcional)
    if (EJS.PK) {
        emailjs.init(EJS.PK);
    }

    ['servicio','horario','duracion'].forEach(id =>
        document.getElementById(id).addEventListener('change', calcularCosto));

    Object.keys(costosAdicionales).forEach(k =>
        document.getElementById(k)?.addEventListener('change', calcularCosto));

    ['email','telefono','direccion','nombre-cliente','nombre-paciente','edad-paciente','relacion']
        .forEach(id => document.getElementById(id).addEventListener('input', validarForm));

    document.getElementById('terminos').addEventListener('change', validarForm);
    document.getElementById('btn-cotizar').addEventListener('click', procesarSolicitud);
    document.getElementById('btn-confirmar-whatsapp').addEventListener('click', enviarWhatsAppAgencia);

    ['btn-borrar','btn-nueva-cotizacion','btn-cancelar'].forEach(id =>
        document.getElementById(id).addEventListener('click', limpiarForm));

    validarForm();
});
